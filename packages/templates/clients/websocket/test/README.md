## Prerequisites

Install [Podman](https://podman.io/docs/installation). 

> Microcks needs some services running to simulate the infrastructure and this requires multiple resources. Docker is not the best solution for this, thus it's better to use Podman that manages resources better.

You can also install [docker-compose](https://docs.docker.com/compose/install/) that `podman compose` will later use.

## Test Project

This `test` directory contains acceptance tests that check different clients with tests written in their respective languages. So JavaScript client is tested with JavaScript test, and Python with Python tests, and so on.

To run tests: `cd microcks-setup && podman compose -f microcks-podman.yml --profile tests up -d`

> You need to remember about `--profile tests` to run whole setup with tests. This way you ensure that proper importer container imports `__fixtures__/asyncapi-hoppscotch-server.yml` into Microcks and tests run against it.

## Testing Clients with Microcks

This instruction is just a set of notes about how to play locally with Microcks that we already use for automated testing.

Tests also run in containers, although with provided configuration you can start also testing environment without running tests, just to play with Microcks and understand more how it works.

### Concept

Microcks is a tool for mocking. To test our generated clients, we need to mock the server. In other words, if we want to check if the generated client for Postman works well, we need to mock the server that the client will communicate with during testing.

### Using Microcks locally

> This instruction assumes you are located in directory where `microcks-setup` directory is located

#### Start Microcks

1. Start Microcks infrastructure: `podman compose -f ./microcks-setup/microcks-podman.yml up -d`.

1. Check with `podman ps` command if all services are running. It may take few minutes to start all containers. You can also run a special script that will confirm that services are ready: `bash ./microcks-setup/checkMicrocksReady.sh`.

1. Access Microcks UI with `open http://localhost:8080`.

#### Load AsyncAPI documents

To test clients, we need to mock the server. Remember to load AsyncAPI documents that represent the server.

1. Install [Microcks CLI](https://microcks.io/documentation/guides/automation/cli/)

1. Import AsyncAPI document
    ```bash
    microcks-cli import __fixtures__/asyncapi-postman-echo.yml \
      --microcksURL=http://localhost:8080/api/ \
      --keycloakClientId=microcks-serviceaccount \
      --keycloakClientSecret="ab54d329-e435-41ae-a900-ec6b3fe15c54"
    ```

1. See the mock in the Microcks UI with `open http://localhost:8080/#/services`

#### Invoke Mocks tests

Start simple testing of the mock to see if it was created properly. Tests should turn green.

You should run tests only on one operation at a time.

```bash
# the higher timeout the more test samples will run
microcks-cli test 'Postman Echo WebSocket Client:1.0.0' ws://localhost:8081/api/ws/Postman+Echo+WebSocket+Client/1.0.0/sendTimeStampMessage ASYNC_API_SCHEMA \
    --microcksURL=http://localhost:8080/api/ \
    --insecure \
    --waitFor=15sec \
    --keycloakClientId=microcks-serviceaccount \
    --keycloakClientSecret="ab54d329-e435-41ae-a900-ec6b3fe15c54" \
    --filteredOperations="[\"SEND sendEchoMessage\"]"
```

You can also check the status of tests in the Microcks UI.

### Debugging 

File `microcks-podman.yml` contains commented out configuration for debbuging container you can start with the entire testing environment.

It's also useful to connect to Microcks containers and checkout logs: `podman logs -f  microcks-async-minion`. Minion is the service that handles API calls.

### Cleanup

Run `podman compose -f ./microcks-setup/microcks-podman.yml down --remove-orphans` to clean everything.

## Playing with Microcks Mock Server

You can also check the websocket endpoints generated by Microcks in the terminal using [websocat](https://github.com/vi/websocat).

Do below to start receiving example messages in the terminal:
```
websocat ws://localhost:8081/api/ws/Hoppscotch+WebSocket+Server/1.0.0/sendTimeStampMessage
```