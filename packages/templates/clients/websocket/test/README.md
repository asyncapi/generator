## Test Project

This `test` directory contains two types of testing: 
- [Acceptance Testing](#acceptance-testing)
- [Integration Testing](#integration-testing)

## Acceptance testing

The acceptance tests check different clients with tests written in their respective languages. So JavaScript client is tested with JavaScript test, and Python with Python tests, and so on.

## Prerequisites

Install [Podman](https://podman.io/docs/installation). 

> Microcks needs some services running to simulate the infrastructure and this requires multiple resources. Docker is not the best solution for this, thus it's better to use Podman that manages resources better.

You can also install [docker-compose](https://docs.docker.com/compose/install/) that `podman compose` will later use.

To run tests: 

1. Go to microcks directory: `cd microcks-setup`

1. Setup infra based on Microcks and proper AsyncAPI documents: `podman compose -f microcks-podman.yml --profile infra up -d`

    > You need to remember about `--profile infra` to run whole setup with tests. This way you ensure that the `asyncapi-bundler` service produces `__fixtures__/bundled.yml`, which the importer container will import into Microcks.

1. Run tests for given client, for example `podman compose -f microcks-podman.yml --profile test-js up --abort-on-container-exit` to run JS client tests. Use `test-py` profile for Python client tests.

## Testing Clients with Microcks

This instruction is just a set of notes about how to play locally with Microcks that we already use for automated testing.

Tests also run in containers, although with provided configuration you can start also testing environment without running tests, just to play with Microcks and understand more how it works.

### Concept

Microcks is a tool for mocking. To test our generated clients, we need to mock the server. In other words, if we want to check if the generated client for Postman works well, we need to mock the server that the client will communicate with during testing.

### Using Microcks locally

> This instruction assumes you are located in directory where `microcks-setup` directory is located

#### Start Microcks

1. Start Microcks infrastructure: 
    - Go to microcks directory: `cd microcks-setup`
    - Setup infra: `podman compose -f microcks-podman.yml --profile infra up -d`.

1. Check with `podman ps` command if all services are running. It may take few minutes to start all containers. You can also run a special script that will confirm that services are ready: `bash ./microcks-setup/checkMicrocksReady.sh`.

1. Access Microcks UI with `open http://localhost:8080`.

#### Load AsyncAPI documents

To test clients, we need to mock the server. Remember to load AsyncAPI documents that represent the server.

> If you work with documents that contain `$ref` pointing to external files, like for example `packages/templates/clients/websocket/test/__fixtures__/asyncapi-hoppscotch-client.yml`, you need to first bundle them into a single AsyncAPI document. Instal AsyncAPI CLI and use `bundle` command. 

1. Install [Microcks CLI](https://microcks.io/documentation/guides/automation/cli/)

1. Import AsyncAPI document
    ```bash
    microcks-cli import __fixtures__/asyncapi-postman-echo.yml \
      --microcksURL=http://localhost:8080/api/ \
      --keycloakClientId=microcks-serviceaccount \
      --keycloakClientSecret="ab54d329-e435-41ae-a900-ec6b3fe15c54"
    ```

1. See the mock in the Microcks UI with `open http://localhost:8080/#/services`

#### Invoke Mocks tests

Start simple testing of the mock to see if it was created properly. Tests should turn green.

You should run tests only on one operation at a time.

```bash
# the higher timeout the more test samples will run
microcks-cli test 'Postman Echo WebSocket Client:1.0.0' ws://localhost:8081/api/ws/Postman+Echo+WebSocket+Client/1.0.0/sendEchoMessage ASYNC_API_SCHEMA \
    --microcksURL=http://localhost:8080/api/ \
    --insecure \
    --waitFor=15sec \
    --keycloakClientId=microcks-serviceaccount \
    --keycloakClientSecret="ab54d329-e435-41ae-a900-ec6b3fe15c54" \
    --filteredOperations="[\"SEND sendEchoMessage\"]"
```

You can also check the status of tests in the Microcks UI.

### Debugging 

File `microcks-podman.yml` contains commented out configuration for debbuging container you can start with the entire testing environment.

It's also useful to connect to Microcks containers and checkout logs: `podman logs -f  microcks-async-minion`. Minion is the service that handles API calls.

### Cleanup

Run `podman compose -f ./microcks-setup/microcks-podman.yml down --remove-orphans` to clean everything.

## Playing with Microcks Mock Server

You can also check the websocket endpoints generated by Microcks in the terminal using [websocat](https://github.com/vi/websocat).

Do below to start receiving example messages in the terminal:
```
websocat ws://localhost:8081/api/ws/Hoppscotch+WebSocket+Server/1.0.0/sendTimeStampMessage
```

## Integration Testing 

The integration tests follow a centralized approach: they use common test helpers for standard validations and include only custom tests for template-specific features.

### Adding a New Client to Integration Tests

1. Go to integration test suite: `cd integration-test`.

2. Add your client configuration to `languageConfig` in `integration.test.js`:
```js
const languageConfig = {
  // ...existing configs
  yourlang: {
    clientFileName: your_client_filename,
    testResultPath: generated_client_path,
    template: your_template_path
  }
}
```

3. Add a new describe block inside main `WebSocket Clients Integration Tests` block following this pattern:
```js
describe('YourLang Client', () => {
  // Runs all standard tests
  runCommonTests('YourLang', languageConfig.YourLang);

  // Add template-specific tests below
  describe('Additional tests', () => {
    it('should handle specific feature', async () => {
      // Custom test implementation
    });
  });
});
```

4. Run `npm run test:update` to generate client on the `testResultPath`. 